# Local Collector Sink

Convenience for simple consumption of pipeline results.

## Getting Started

Local Collector Sink allows your application to register itself to receive result generated by your processing pipeline.
Have a look:
```java
@Test
    public void localCollectorExample() {
        JetInstance jetInstance = Jet.newJetInstance();

        // create new Local Collector
        LocalCollector<Double> collector = LocalCollector.<Double>createNew(jetInstance)
                .consumer(LocalCollectorTest::consumeResultItem)
                .exceptionConsumer(Throwable::printStackTrace)
                .start();

        // Pipeline calculating average of random numbers in 1s windows
        Pipeline pipeline = Pipeline.create();
        pipeline.drawFrom(createSource())
                .withIngestionTimestamps()
                .window(tumbling(1000))
                .aggregate(averagingLong(e -> e))
                .map(WindowResult::result)
                .drainTo(collector.asSink()); // Connect Pipeline with the Local Collector

        // submit Pipeline to Jet
        jetInstance.newJob(pipeline).join();
    }

    // this method will be called for each item produced by the Pipeline
    private static <T> void consumeResultItem(T item) {
        System.out.println(item);
    }

    // source generating random integers
    private StreamSource<Integer> createSource() {
        return SourceBuilder.stream("mySource", c -> new Random())
                    .<Integer>fillBufferFn((c, b) -> b.add(c.nextInt()))
                    .build();
    }

```  
The `consumeResultItem()` method is called for each item generated by the pipeline. 
This makes is very easy to connect processing pipelines into the rest of your application.


### Installing

The Local Collector Sink artifacts are published on the Maven repositories. 
Add the following lines to your pom.xml to include it as a dependency to your project:

```
<dependency>
    <groupId>com.hazelcast.jet.contrib</groupId>
    <artifactId>local-collector</artifactId>
    <version>${version}</version>
</dependency>
```

or if you are using Gradle: 
```
compile group: 'com.hazelcast.jet.contrib', name: 'local-collector', version: ${version}
```

### FAQ
Q: What is a good use-case for this collector? 
A: Pipelines which process huge rate of incoming data aggregate them in some form and then store
   the aggregation results. If aggregation results is much smaller rate than was the original input.
   
   Imagine a pipeline to detect possible fraud transactions in credit card payment stream. The input is massive:
   all credit card transations. The output will much *much* smaller: Just the fraudulent transactions.

Q: What if the application which submitted Pipeline dies?
A: The pipeline will keep running. Local Collector can reconnect to already existing pipeline.
```java
        LocalCollector<Long> collector = LocalCollector.<Long>reconnect(jetInstance)
                .fromLatest()
                .consumer(MyConsumer::accept)
                .name(collectorName)
                .start();
```

Q: How does it work under the hood?
A: It uses a ringbuffer to store results and then polls it and deliver result to your consumers

Q: How to size the backing ringbuffer?
A: Default size is 10,000. This seems to be sufficient unless your pipeline generates 10,000s items / second. If your
pipeline generates huge amount of items / second then you should probably use another Sink. 

Q: How to make it resiliant against occasional hiccups?
A: Occasional hiccups on a consumer side can cause an issue, because producers might overwrite items stored in ringbuffer
before the items were consumed. If this is detected then the Local Collector declares an error, notify your
exceptionConsumer and stops consuming new items. If you can tolerate occasional lost items then you can instruct the
collector to simply skip missing lost items:
```java
LocalCollector<Double> collector = LocalCollector.<Double>createNew(jetInstance)
                .consumer(LocalCollectorTest::consumeResultItem)
                .exceptionConsumer(Throwable::printStackTrace)
                .skipLostItems()
                .start();

``` 


Check out `com.hazelcast.jet.contrib.localcollector.LocalCollectorTest` test class for a more 
complete setup.

### Running the tests

To run the tests run the command below: 

```
./gradlew test
```

## Authors

* **[Jaromir Hamala](https://github.com/jerrinot)**
